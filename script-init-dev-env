#!/bin/bash

# Vérifier que le script n'est pas lancé en root
if [ "$EUID" -eq 0 ]; then
   echo "ERREUR: Ce script ne doit PAS être lancé en root ou avec sudo"
   echo "Lancez-le en tant qu'utilisateur normal"
   exit 1
fi

echo "======================================"
echo "Installation de l'environnement de développement Simon"
echo "======================================"
echo ""

sudo apt update

# installer docker si non présent ou non fonctionnel
if ! docker ps &> /dev/null; then
    echo "Docker n'est pas disponible ou ne fonctionne pas. Installation..."

    # Vérifier si on est sur WSL
    if grep -qi microsoft /proc/version; then
        echo "ATTENTION: Vous êtes sur WSL 2."
        echo "Il est recommandé d'utiliser Docker Desktop avec l'intégration WSL 2."
        echo "Téléchargez-le depuis: https://www.docker.com/products/docker-desktop"
        echo ""
        read -p "Voulez-vous quand même installer Docker directement dans WSL ? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Installation annulée. Installez Docker Desktop et réexécutez ce script."
            exit 1
        fi
    fi

    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
    rm get-docker.sh
    echo "Docker installé."

    # Ajouter l'utilisateur actuel au groupe docker
    sudo usermod -aG docker $USER
    echo "Vous avez été ajouté au groupe docker. Vous devrez peut-être vous reconnecter."

    # Démarrer le service Docker
    sudo service docker start

    echo ""
    echo "IMPORTANT: Vous devez vous reconnecter pour que les changements prennent effet."
    echo "Après reconnexion, réexécutez ce script."
    exit 0
fi

# configurer docker pour le registry local
mkdir -p ~/.docker
cat > ~/.docker/config.json << 'EOF'
{
  "auths": {
    "localhost:5000": {}
  }
}
EOF
echo "Configuration Docker créée pour le registry local"

# installer minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube
rm minikube-linux-amd64

# démarrer minikube avec docker driver et profil dev
minikube start -p dev --driver=docker

# installer kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
rm kubectl

# mettre à jour le contexte kubectl pour le cluster dev
minikube update-context -p dev

# activer le registry addon de minikube sur le cluster dev
minikube addons enable registry -p dev

# configurer le port forwarding pour accéder à la registry depuis l'hôte
kubectl port-forward --namespace kube-system service/registry 5000:80 > /dev/null 2>&1 &

# installer skaffold
curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
sudo install skaffold /usr/local/bin/
rm skaffold

# cloner le frontend client
git clone https://iut-git.unice.fr/simon/simon

# cloner les API
mkdir -p APIs
cd APIs
git clone https://iut-git.unice.fr/simon/services/api-capteur
git clone https://iut-git.unice.fr/simon/services/api-ingestion
git clone https://iut-git.unice.fr/simon/services/api-auth-user
git clone https://iut-git.unice.fr/simon/services/api-gateway-client

echo ""
echo "======================================"
echo "Installation terminée avec succès !"
echo "======================================"
echo ""
echo "Pour démarrer l'environnement de développement :"
echo "  cd simon/infra/dev"
echo "  skaffold dev"
echo ""
echo "Services qui seront accessibles :"
echo "  - Frontend:        http://localhost:8080"
echo "  - API Capteur:     http://localhost:3000"
echo "  - API Ingestion:   http://localhost:3001"
echo "  - API Auth User:   http://localhost:3002"
echo "  - API Gateway:     http://localhost:3003"
echo "  - PostgreSQL:      localhost:5432"
echo ""
echo "Commandes utiles :"
echo "  minikube profile dev    # Activer le profil dev"
echo "  kubectl get pods        # Voir les pods"
echo "  minikube dashboard      # Interface web Kubernetes"
echo ""
