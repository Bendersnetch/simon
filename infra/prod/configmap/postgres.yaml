apiVersion: v1
kind: ConfigMap
metadata:
  name: postgis-init-config
data:
  init-postgis.sh: |
    #!/bin/bash
    set -e

    # Connexion à la DB définie par les variables d'env et création des extensions
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
        CREATE EXTENSION IF NOT EXISTS postgis;
        CREATE EXTENSION IF NOT EXISTS postgis_topology;
        CREATE EXTENSION IF NOT EXISTS fuzzystrmatch;
        CREATE EXTENSION IF NOT EXISTS postgis_tiger_geocoder;
    EOSQL

    # Création de l'utilisateur et de la base de données pour l'API capteur
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname postgres <<-EOSQL
        -- Créer l'utilisateur prod_user s'il n'existe pas
        DO \$\$
        BEGIN
          IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'prod_user') THEN
            CREATE USER prod_user WITH PASSWORD '$ROOT_PASSWORD';
          END IF;
        END
        \$\$;

        -- Créer la base de données projet_simon_prod si elle n'existe pas
        SELECT 'CREATE DATABASE projet_simon_prod OWNER prod_user'
        WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'projet_simon_prod')\gexec

        -- Donner tous les privilèges à l'utilisateur prod_user
        GRANT ALL PRIVILEGES ON DATABASE projet_simon_prod TO prod_user;
    EOSQL

    # Activer PostGIS sur la nouvelle base de données
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname projet_simon_prod <<-EOSQL
        CREATE EXTENSION IF NOT EXISTS postgis;
        CREATE EXTENSION IF NOT EXISTS postgis_topology;
        CREATE EXTENSION IF NOT EXISTS fuzzystrmatch;
        CREATE EXTENSION IF NOT EXISTS postgis_tiger_geocoder;

        -- Donner les permissions sur le schéma public
        GRANT ALL ON SCHEMA public TO prod_user;
        GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO prod_user;
        GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO prod_user;
        ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO prod_user;
        ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO prod_user;
    EOSQL
